{% extends "base.html" %}

{% block title %}Resultados da Sessão - StudyHub{% endblock %}

{% block content %}
    <h2>Resultados da Sessão de Estudo</h2>
    <p><strong>Data:</strong> {{ session.timestamp.strftime('%d/%m/%Y %H:%M') }}</p>
    <p><strong>Score:</strong> 
        {% if session.status == 'completed' and session.score_percentage is not none %}
            {{ "%.2f"|format(session.score_percentage) }}%
            ({{ session.correct_answers_in_session if session.correct_answers_in_session is not none else '?' }} de {{ session.total_questions_in_session if session.total_questions_in_session is not none else '?' }} questões corretas)
        {% elif session.status == 'in_progress' %}
            Sessão em progresso ({{ session.correct_answers_in_session if session.correct_answers_in_session is not none else '0' }}/{{ session.total_questions_in_session if session.total_questions_in_session is not none else '0' }} respondidas corretamente até agora)
        {% else %}
            Score não aplicável ({{ session.status | capitalize }})
        {% endif %}
    </p>
    <hr>

    {% if results %}
        <h3>Respostas Detalhadas:</h3>
        <table class="results-table">
            <thead>
                <tr>
                    <th>ID Questão</th>
                    <th>Título da Questão</th>
                    <th>Sua(s) Resposta(s)</th>
                    <th>Resultado</th>
                    <th>Revisar Questão</th>
                    <th>Link Externo</th>
                </tr>
            </thead>
            <tbody>
                {% for item in results %}
                    <tr>
                        <td>{{ item.response.question_id_original }}</td>
                        <td>{{ item.question_title }}</td>
                        <td>
                           {{ item.user_answers_display }}
                        </td>
                        <td>
                            {% if item.response.is_correct %}
                                <span style="color: green; font-weight: bold;">Correto</span>
                            {% else %}
                                <span style="color: red; font-weight: bold;">Incorreto</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.question_url_internal and item.question_url_internal != '#' %}
                                <a href="{{ item.question_url_internal }}">Revisar no App</a>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if item.question_url_external and item.question_url_external != '#' %}
                                <a href="{{ item.question_url_external }}" target="_blank" rel="noopener noreferrer">Ver no ExamTopics</a>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Nenhuma resposta registrada para esta sessão.</p>
    {% endif %}

    <p style="margin-top: 20px;">
        <a href="{{ url_for('my_study_sessions') }}" class="btn btn-secondary">Voltar para Histórico</a>
        <a href="{{ url_for('start_new_study') }}" class="btn btn-primary">Iniciar Novo Estudo</a>
    </p>
{% endblock %}

{% block head_extra %}
<style>
    /* Estilos já presentes no style.css, mas replicados para garantir se não for carregado */
    .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .results-table th { background-color: #f2f2f2; }
    .results-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
</style>
{% endblock %}