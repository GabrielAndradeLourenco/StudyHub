{% extends "base.html" %}

{% block title %}Revisão Questão {{ question_index + 1 }} - StudyHub{% endblock %}

{% block head_extra %}
<style>
    .question-block { margin-bottom: 30px; padding-bottom: 20px; }
    h2.question-title { color: #2c3e50; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 10px;}
    h3.section-title { color: #34495e; margin-top: 20px; }
    ul.options-list { list-style-type: none; padding-left: 0; }
    ul.options-list li { 
        background-color: #f9f9f9; border: 1px solid #eee; 
        margin-bottom: 8px; padding: 12px 15px; border-radius: 4px; 
        cursor: default; 
    }
    .enunciado-html img { max-width: 100%; height: auto; border: 1px solid #ddd; padding: 4px; border-radius: 4px; margin-top: 10px; margin-bottom:10px; }
    .enunciado-html pre { background-color: #f0f0f0; padding: 15px; border: 1px solid #ccc; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    
    ul.options-list li.user-correct { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724 !important; font-weight: bold; }
    ul.options-list li.user-incorrect { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; }
    ul.options-list li.actual-correct { border: 2px solid #28a745 !important; }
    
    .navigation-links { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }

    .answered-info {
        margin-top: 15px; padding: 10px; border-radius: 4px;
        font-weight: bold;
    }
    .answered-info.correct { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
    .answered-info.incorrect { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .answered-info.not-answered { color: #495057; background-color: #e2e3e5; border: 1px solid #d6d8db;}
</style>
{% endblock %}

{% block content %}
    <div class="question-block">
        <h2 class="question-title">Revisando Questão {{ question_index + 1 }} de {{ total_questions }}</h2>
        <p><small>ID Original: {{ question.id_original_json if question.id_original_json is not none else 'N/A' }} | 
            Sessão de Estudo: {{ session_context.timestamp.strftime('%d/%m/%Y %H:%M') }} (ID: {{ session_context.id }}) |
            <a href="{{ question.url_original if question.url_original else '#' }}" target="_blank" rel="noopener noreferrer">Ver no ExamTopics</a></small>
        </p>
        
        <h3 class="section-title">Enunciado:</h3>
        <div class="enunciado-html">
            {{ question.enunciado_html | safe if question.enunciado_html else '<p><em>Enunciado não disponível.</em></p>' }}
        </div>

        {% if question.opcoes %}
            {% set num_to_select_review = question.num_answers_to_select if (question.num_answers_to_select is defined and question.num_answers_to_select > 0) else 1 %}
            <h3 class="section-title">Opções: (Gabarito sugere selecionar {{ num_to_select_review }}):</h3>
            
            <ul class="options-list">
                {% for opt in question.opcoes %}
                    <li 
                        class="
                        {# Marca as respostas que o usuário deu nesta sessão #}
                        {% if user_response_in_session and user_response_letters_review and opt.letra in user_response_letters_review %}
                            {% if user_response_in_session.is_correct %}user-correct{% else %}user-incorrect{% endif %}
                        {% endif %}
                        {# Marca as respostas corretas de acordo com o gabarito do JSON #}
                        {% if question.resposta_sugerida_letra and opt.letra in question.resposta_sugerida_letra %}actual-correct{% endif %}
                        "
                    >
                        <strong>{{ opt.letra_raw }}</strong> {{ opt.texto }}
                    </li>
                {% endfor %}
            </ul>

            {% if user_response_in_session %}
                <div class="answered-info {% if user_response_in_session.is_correct %}correct{% else %}incorrect{% endif %}">
                    Sua(s) resposta(s) nesta sessão foi(ram): <strong>{{ user_response_letters_review|join(', ') if user_response_letters_review else 'N/A' }}</strong>.
                    {% if not user_response_in_session.is_correct and question.resposta_sugerida_letra and question.resposta_sugerida_letra|string|trim != "" %}
                        A(s) resposta(s) correta(s) era(m): {{ question.resposta_sugerida_letra }}.
                    {% endif %}
                </div>
            {% else %}
                 <div class="answered-info not-answered">
                    Você não respondeu esta questão nesta sessão.
                    {% if question.resposta_sugerida_letra and question.resposta_sugerida_letra|string|trim != "" %}
                        A(s) resposta(s) correta(s) era(m): {{ question.resposta_sugerida_letra }}.
                    {% endif %}
                </div>
            {% endif %}

        {% else %}
            <p><em>Nenhuma opção disponível para esta questão.</em></p>
        {% endif %}
    </div>

    <div class="navigation-links">
        <a href="{{ url_for('show_session_results', session_id=session_context.id) }}" class="btn btn-secondary">« Voltar para Resultados da Sessão</a>
        <span> </span> {# Placeholder para manter o layout #}
    </div>
{% endblock %}